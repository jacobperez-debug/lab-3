---
title: "Science and Trust"
format:
  dashboard:
    orientation: rows
    nav-buttons: [linkedin, github]
    linkedin: www.linkedin.com/in/jacob-u-perez
    github: https://github.com/jacobperez-debug
    theme: journal
---

```{r}
#|label: libraries

library(tidyverse)
library(ggplot2)
library(readxl)
```

```{r}
#|label: read in data

wgm2018 <- read_excel(here::here("wgm2018-dataset-crosstabs-all-countries.xlsx"), sheet = 2)

wgm2018.3 <- read_excel(here::here("wgm2018-dataset-crosstabs-all-countries.xlsx"), sheet = 3)

wgm2020 <- read.csv(here::here("wgm_full_wave2_public_file_final (1)_csv.csv"))
```

```{r}
df_raw_2018 <- tibble(x = str_split(wgm2018.3$`Variable Type & Codes*`[1], ',\\s')[[1]])

df_countries_2018 <- df_raw_2018 %>%
  separate_wider_delim(x, delim = '=', names = c("country_id", "country_name")) %>%
  mutate(country_id = as.numeric(country_id))

df_wgm2018 <-  left_join(wgm2018, df_countries_2018, by = c("WP5" = "country_id")) %>%
  mutate(region = case_when(
    Regions_Report %in% c(1, 2, 4, 5) ~ "Africa",
    Regions_Report %in% c(6, 7, 8) ~ "Americas",
    Regions_Report %in% c(9, 10, 11, 12, 18) ~ "Asia",
    Regions_Report %in% c(3, 13) ~ "Middle East and North Africa",
    Regions_Report %in% c(14) ~ "Former Soviet Union",
    Regions_Report %in% c(15, 16, 17, 0) ~ "Europe"
  )) %>%
  select(country_name, region, wgt, Q11B, Q11C, Q16)
```

```{r}
df_wgm2020 <- wgm2020 %>%
  mutate(region = case_when(
    Global11Regions %in% c(11) ~ "Middle East and Africa",
    Global11Regions %in% c(9, 10) ~ "Americas",
    Global11Regions %in% c(4, 6, 7, 8, 5) ~ "Asia",
    Global11Regions %in% c(3) ~ "Russia/Caucasus/Central",
    Global11Regions %in% c(1, 2) ~ "Europe"
  )) %>%
  select(COUNTRYNEW, region, WGT, W5B, W5C, W8)
```

# Trust in Science

## Global Trust in Scientists Facts (Row 1) {height = 10%}

Explore how attitudes toward scientists and scientific information shifted between 2018 and 2020.

## Global Trust in Scientists Plots (Row 2) 

### 2018 {.tabset}

#### Global

```{r}
trust2018 <- df_wgm2018 %>%
  filter(!is.na(Q11C)) %>%
  mutate(
    is_1_or_2 = if_else(Q11C %in% c(1, 2), 1, 0),
    weighted_is_1_or_2 = wgt * is_1_or_2
  ) %>%
  group_by(country_name, region) %>%
  summarise(
    percent = 100 * sum(weighted_is_1_or_2, na.rm = TRUE) / sum(wgt, na.rm = TRUE)
  )
```

```{r}
ggplot(trust2018, aes(x = percent)) +
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Africa

```{r}
trust2018 %>% 
  filter(region == "Africa") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Americas

```{r}
trust2018 %>% 
  filter(region == "Americas") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Asia

```{r}
trust2018 %>% 
  filter(region == "Asia") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Europe

```{r}
trust2018 %>% 
  filter(region == "Europe") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Former Soviet Union

```{r}
trust2018 %>% 
  filter(region == "Former Soviet Union") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Middle East and North Africa

```{r}
trust2018 %>% 
  filter(region == "Middle East and North Africa") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

### 2020 {.tabset}

#### Global 

```{r}
trust2020 <- df_wgm2020 %>%
  filter(!is.na(W5C)) %>%
  mutate(
    is_1_or_2 = if_else(W5C %in% c(1, 2), 1, 0),
    weighted_is_1_or_2 = WGT * is_1_or_2
  ) %>%
  group_by(COUNTRYNEW, region) %>%
  summarise(
    percent = 100 * sum(weighted_is_1_or_2, na.rm = TRUE) / sum(WGT, na.rm = TRUE)
  )
```

```{r}
ggplot(trust2020, aes(x = percent)) +
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Americas

```{r}
trust2020 %>% 
  filter(region == "Americas") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Asia

```{r}
trust2020 %>% 
  filter(region == "Asia") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Europe

```{r}
trust2020 %>% 
  filter(region == "Europe") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Middle East and Africa

```{r}
trust2020 %>% 
  filter(region == "Middle East and Africa") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

#### Russia/Caucasus/Central

```{r}
trust2020 %>% 
  filter(region == "Russia/Caucasus/Central") %>%
  ggplot(aes(x = percent)) + 
  geom_histogram(binwidth = 3, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Percentages",
    x = "% of Responses",
    y = NULL
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

## Global Trust in Scientists Cards (Row 3)

### Card 1 {orientation = "columns"}

#### Facts {orientation = "columns}

```{r}
trusted_by_2018 <- df_wgm2018 %>%
  filter(!is.na(Q11C)) %>%
  mutate(
    trusted = if_else(Q11C %in% c(1, 2), 1, 0),
    weighted_trusted = wgt * trusted
  ) %>%
  group_by(region) %>%
  summarise(
    percent_trusted = 100 * sum(weighted_trusted, na.rm = TRUE) / sum(wgt, na.rm = TRUE)
  ) %>%
  mutate(
    Percent = round(percent_trusted, 2),
    Region = region
  ) %>%
  select(Region, Percent)

knitr::kable(trusted_by_2018)
```

### Card 2 

```{r}
#| content: valuebox
#| title: "% in 2018"

value1 <- df_wgm2018 %>%
  filter(!is.na(Q11C)) %>%
  summarise(
    trust_percent = 100 * sum(wgt[Q11C %in% c(1, 2)]) / sum(wgt)
  )

list(
  icon = "heart-pulse",
  value = round(value1$trust_percent, 2)
)
```

```{r}
#| content: valuebox
#| title: "% in 2020"

value2 <- df_wgm2020 %>%
  filter(!is.na(W5C)) %>%
  summarise(
    trust_percent = 100 * sum(WGT[W5C %in% c(1, 2)]) / sum(WGT)
  )

list(
  icon = "virus",
  value = round(value2$trust_percent, 2)
)
```

### Card 3 

```{r}
trusted_by_2020 <- df_wgm2020 %>%
  filter(!is.na(W5C)) %>%
  mutate(
    trusted = if_else(W5C %in% c(1, 2), 1, 0),
    weighted_trusted = WGT * trusted
  ) %>%
  group_by(region) %>%
  summarise(
    percent_trusted = 100 * sum(weighted_trusted, na.rm = TRUE) / sum(WGT, na.rm = TRUE)
  ) %>%
  mutate(
    Percent = round(percent_trusted, 2),
    Region = region
  ) %>%
  select(Region, Percent)

knitr::kable(trusted_by_2020)
```

# Is Science Beneficial

## Vaccine Confidence Intro
How did belief in science benefiting your country change before and during the COVID-19 pandemic?

### 2018 vs 2020

```{r}
#ggplot: bar chart or line comparing global % across years

2+1
```

### Regional Breakdown

```{r}
## grouped bar plot: vaccine trust by region

3*3
```

## Global Map

```{r}
# Leaflet map: shade countries by % who agree vaccines are safe

5+5
```



